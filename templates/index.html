<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edmund</title>
    <link rel="icon" type="image/x-icon" href="{{ url_for('static', filename='favicon.ico') }}">
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <div class="header">
        <img src="{{ url_for('static', filename='images/edmund_logo.png') }}" alt="Edmund Logo" class="logo-img">
        <h1>Edmund</h1>
    </div>

    <div class="main-container">
        <!-- Chat Panel -->
        <div class="panel chat-panel">
            <div class="chat-messages" id="chat-messages"></div>
            <div class="chat-input-container">
                <div class="chat-input-wrapper">
                    <input type="text" id="message-input" placeholder="Type your message...">
                    <button id="send-button">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M22 2L11 13" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>

        <!-- Essay Panel -->
        <div class="panel essay-panel" id="essay-panel">
            <div class="essay-content" id="essay-content">
                <!-- Essay content will be inserted here -->
            </div>
        </div>
    </div>

    <div class="footer">
        <p>Created by Luke McMeans (2025)</p>
    </div>

    <!-- Mobile overlay -->
    <div class="overlay" id="overlay"></div>

    <script>
        // DOM Elements
        const chatMessages = document.getElementById('chat-messages');
        const messageInput = document.getElementById('message-input');
        const sendButton = document.getElementById('send-button');
        const essayPanel = document.getElementById('essay-panel');
        const essayContent = document.getElementById('essay-content');
        const overlay = document.getElementById('overlay');
        
        // Set essay content with Markdown rendering
        essayContent.innerHTML = marked.parse(`{{ essay|safe }}`);
        
        // Conversation memory (cleared on refresh)
        let conversation = [
            { role: "model", parts: [{ text: "Hello! I'm Edmund, your AI assistant. How can I help you today?" }] }
        ];
        
        // Add a message to the chat
        function addMessage(user, message, isUser = false) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.classList.add(isUser ? 'user' : 'bot');
            const userElement = document.createElement('div');
            userElement.classList.add('message-user');
            userElement.textContent = user;
            const bubbleElement = document.createElement('div');
            bubbleElement.classList.add('message-bubble');
            bubbleElement.textContent = message;
            messageElement.appendChild(userElement);
            messageElement.appendChild(bubbleElement);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Typing animation for bot messages (with markdown)
        function addBotMessageTyping(user, message, typingSpeed = 12) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message', 'bot');
            const userElement = document.createElement('div');
            userElement.classList.add('message-user');
            userElement.textContent = user;
            const bubbleElement = document.createElement('div');
            bubbleElement.classList.add('message-bubble');
            bubbleElement.innerHTML = '';
            messageElement.appendChild(userElement);
            messageElement.appendChild(bubbleElement);
            chatMessages.appendChild(messageElement);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            let i = 0;
            function typeChar() {
                if (i <= message.length) {
                    bubbleElement.innerHTML = marked.parse(message.slice(0, i));
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    i++;
                    setTimeout(typeChar, typingSpeed);
                }
            }
            typeChar();
        }
        
        // Send a message
        function sendMessage() {
            const message = messageInput.value.trim();
            if (message) {
                addMessage('You', message, true);
                conversation.push({ role: "user", parts: [{ text: message }] });
                messageInput.value = '';
                // Fetch Gemini response with conversation memory
                fetch('/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ conversation })
                })
                .then(res => res.json())
                .then(data => {
                    if (data.message) {
                        addBotMessageTyping('Edmund', data.message);
                        conversation.push({ role: "model", parts: [{ text: data.message }] });
                    } else {
                        addBotMessageTyping('Edmund', 'Sorry, I could not get a response.');
                    }
                })
                .catch(() => {
                    addBotMessageTyping('Edmund', 'Sorry, there was an error connecting to the server.');
                });
            }
        }
        
        // Event Listeners
        sendButton.addEventListener('click', sendMessage);
        
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // For mobile: toggle essay panel
        function setupEssayToggle() {
            if (window.innerWidth <= 768 && !document.querySelector('.toggle-essay')) {
                const toggleEssay = document.createElement('button');
                toggleEssay.classList.add('toggle-essay');
                toggleEssay.innerHTML = `
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM19 19H5V5H19V19Z" fill="currentColor"/>
                        <path d="M7 7H17V9H7V7Z" fill="currentColor"/>
                        <path d="M7 11H17V13H7V11Z" fill="currentColor"/>
                        <path d="M7 15H13V17H7V15Z" fill="currentColor"/>
                    </svg>
                `;
                document.body.appendChild(toggleEssay);
                
                toggleEssay.addEventListener('click', () => {
                    essayPanel.classList.add('active');
                    overlay.classList.add('active');
                });
                
                overlay.addEventListener('click', () => {
                    essayPanel.classList.remove('active');
                    overlay.classList.remove('active');
                });
            }
        }
        document.addEventListener('DOMContentLoaded', setupEssayToggle);
        window.addEventListener('resize', () => {
            // Remove button if resizing to desktop
            const btn = document.querySelector('.toggle-essay');
            if (window.innerWidth > 768 && btn) btn.remove();
            if (window.innerWidth <= 768) setupEssayToggle();
        });
        
        // On page load, show the welcome message
        addBotMessageTyping('Edmund', conversation[0].parts[0].text);
    </script>
</body>
</html>
